<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../../css/dash_sre.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
    <script src="../../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
</head>

<body>
    <div class="container-all">
        <div class="nav-lateral">
            <div class="logo-dbg">
                <img src="../../assets/imgs/DBG.-logo2png.png" alt="">
            </div>
            <div class="options-nav ">
                <div class="principal-options">
                    <div class="circle-option">
                        <i onclick="window.location.href='#'" class="fa-solid fa-house"></i>
                        <span class="texto-oculto">Início</span>
                    </div>
                    <div class="circle-option">
                        <i onclick="window.location.href='dashHistoricoAlertaSRE.html'" class="fa-solid fa-bug"></i>
                        <span class="texto-oculto">Alertas</span>
                    </div>
                    <div class="circle-option">
                        <i class="fa-solid fa-notes-medical" onclick="window.location.href='dashSaudeServidores.html'"></i>
                        <span class="texto-oculto">Configurações</span>
                    </div>
                </div>
                <div class="area-logoff">
                    <div class="circle-option logoff" onclick="limparSessao()">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <span class="texto-oculto" style="color: red;">Sair</span>
                    </div>
                </div>
            </div>
        </div>


        
        <div class="corpo">
            <div class="intervalo" >Intervalos de um Desvio-Padrão previstos para os proximos dias  
              <img onclick="mostrar_aviso()" class="toll_tip" src="../../assets/imgs/toll tip.png" height="45px"></div>

            <div class="kpi1">
                <p class="titulo_kpi">CPU Esperada:</p>
                <div class="metade" id="box_1cpu">
                    <p class="desc_metade" id="atual_cpu">2ª metade de novembro <b>(<u>atual)</u></b></p>

                    <p class="medida_metade" id="1_cpu">77%  a 97%</p>
                </div>

                <div class="metade" id="box_2cpu">
                    <p class="desc_metade" id="proxima_cpu">1ª metade de Dezembro  <b>(<u>seguinte)</u></b> </p>

                    <p class="medida_metade" id="2_cpu">80%  a 87%</p>
                </div>

        
            </div>

        
            <div class="kpi2">
            <p class="titulo_kpi">RAM Esperada:</p>
        
                    <div class="metade" style="border-color: green;" id="box_1ram">
                    <p class="desc_metade" id="atual_ram">2ª metade de novembro <b>(<u>atual)</u></b></p>

                    <p class="medida_metade" id="1_ram">55% a 60%</p>
                </div>

                <div class="metade" style="border-color: yellow; " id="box_2ram">
                    <p class="desc_metade" id="proxima_ram">1ª metade de Dezembro  <b>(<u>seguinte)</u></b> </p>

                    <p class="medida_metade" id="2_ram">66% a 70%</p>
                </div>
        </div>

            <div class="vazio"></div>
            <div class="graf">
                <canvas id="grafico"></canvas>
            </div>

        </div>

        <div class="direita_pai">

        <div class="direita1">
            <p class="titulo_direita1">Servidores com Risco de Alerta na CPU nas próximas 3 horas</p>    

            <table class="lista_sv" id="tabela">
                <tr>
                    
                </tr>
                <tr>
                    <td class="img_td"><img src="../../assets/imgs/bandeira_brasil.png" width="80%" ></td>
                    <td>minecraft-main</td>
                    <td style="color: red;">5</td>

                </tr>
                                <tr>
                    <td class="img_td"><img src="../../assets/imgs/bandeira_brasil.png" width="80%" ></td>
                    <td>minecraft-main</td>
                    <td style="color: red;">5</td>

                </tr>
            </table>
        </div>


        <div class="direita2"> 
            <p class="titulo_direita1">Servidores em Risco de Alerta (CPU)</p>                
            
            <canvas id="graf_pizza"></canvas>
        </div>

            
        </div>            


    </div>


    <div id="popup" class="popup">
    <div class="popup_conteudo">
        <p>Nos períodos informados abaixo, aproximadamente 68% do tempo, a porcentagem de uso estará dentro da sua respectiva faixa prevista</p>

        <button onclick="fechar_popup()" class="fechar_popup">Fechar</button>
    </div>
</div>


<p class="titulo">SRE - Previsão de consumo |  Servidores </p>
    <script>

      function mostrar_aviso() {
    document.getElementById("popup").style.display = "flex";
}

function fechar_popup() {
    document.getElementById("popup").style.display = "none";
}


        // LÓGICA DE HOVER DA BARRA LATERAL

        const navLateral = document.querySelector('.nav-lateral');
        const conteudo = document.querySelector('.conteudo');

        navLateral.addEventListener('mouseenter', () => {
            conteudo.classList.add('expand');
        });

        navLateral.addEventListener('mouseleave', () => {
            conteudo.classList.remove('expand');
        });



       

    </script>
</body>

<script>
// Script backend em si:

var alertaGravevar = 0
var alertaLevevar = 0



 entrar()

 function entrar() {
        

        var idEmpresa = sessionStorage.ID_EMPRESA

        console.log("FORM idEmpresa: ", idEmpresa);


        fetch(`/sre_futuro/entrar/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: idEmpresa,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);
                // PEGAR do sessionStorage = var idEmpresa = sessionStorage.ID_EMPRESA;
                // Salvar no sessionStorage = sessionStorage.EMAIL_USUARIO = json.email;
                resposta.json().then(json => {
                    console.log(json);
                    console.log("Print do SRE FUTURO:");
                    
                    console.log(JSON.stringify(json));

                    
                    alertaLevevar = Number ((json[0].alertaLeve));
                    alertaGravevar = Number ((json[0].alertaGrave));

                    buscarServidores()
                
                    
                    

                });

            } else {

                console.log("Houve um erro ao tentar realizar o as previsões com alertas!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    
    var nomesServidores = {}
    var localizacaoServidores = []
    var macServidor = []
    var idServidor = []


  function buscarServidores() {
        
        var idEmpresa = sessionStorage.ID_EMPRESA

        console.log("FORM idEmpresa: ", idEmpresa);


        fetch(`/sre_futuro/buscar/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: idEmpresa,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO buscarServidores()!")

            if (resposta.ok) {
                console.log(resposta);
                // PEGAR do sessionStorage = var idEmpresa = sessionStorage.ID_EMPRESA;
                // Salvar no sessionStorage = sessionStorage.EMAIL_USUARIO = json.email;
                resposta.json().then(json => {
                    console.log(json);
                    console.log("Print do SRE FUTURO: Lista de servidores:");
                    
                    console.log(JSON.stringify(json));

                        for(i = 0; i < json.length; i++){
                            // nomesServidores.push(json[i].apelido);
                            nomesServidores[json[i].macadress] = json[i].apelido;
                            localizacaoServidores.push(json[i].localizacao);
                            macServidor.push(json[i].macadress);
                            idServidor.push(json[i].id);

                        }



                        mandarBuscar ()
                    
                    

                });

            } else {

                console.log("Houve um erro ao tentar realizar o as previsões com alertas!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }


    var kpis = {
        cpumin1 : 0,
        cpumax1: 0,
        cpumin2: 0,
        cpumax2: 0,

        rammin1: 0,
        rammax1: 0,
        rammin2: 0,
        rammax2: 0,
    }







// montando o Site:

var dataAtual = new Date();
var mes = dataAtual.getMonth()
var dia = dataAtual.getDate()
function montar() {


    var dadosCPU2 = tudoCPU.slice(-(dia + 15), -dia)
    var dadosCPU1 = tudoCPU.slice(-(dia + 30), -(dia + 15))

    var dadosRAM2 = tudoRAM.slice(-(dia + 15), -dia)
    var dadosRAM1 = tudoRAM.slice(-(dia + 30), -(dia + 15))


    // calculando o desvio padrão:

    var CPU2desvio = desvioPadrao(dadosCPU2)
    var CPU1desvio = desvioPadrao(dadosCPU1)
    var RAM2desvio = desvioPadrao(dadosRAM2)
    var RAM1desvio = desvioPadrao(dadosRAM1)
    

    var CPU2media = mediaPadrao(dadosCPU2)
    var CPU1media = mediaPadrao(dadosCPU1)
    var RAM2media = mediaPadrao(dadosRAM2)
    var RAM1media = mediaPadrao(dadosRAM1)


    kpis.cpumax1 = (CPU1media + CPU1desvio).toFixed(0)
    kpis.cpumax2 = (CPU2media + CPU2desvio).toFixed(0)

    kpis.rammax1 = (RAM1media + RAM1desvio).toFixed(0)
    kpis.rammax2 = (RAM2media + RAM2desvio).toFixed(0)



    kpis.cpumin1 = (CPU1media - CPU1desvio).toFixed(0)
    kpis.cpumin2 = (CPU2media - CPU2desvio).toFixed(0)

    kpis.rammin1 = (RAM1media - RAM1desvio).toFixed(0)
    kpis.rammin2 = (RAM2media - RAM2desvio).toFixed(0)



    var nomesMeses = [
    "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
]

    var texto = ''
    var texto2 = ''


    if(dia >= 15){
        texto += "2ª"
        texto2 += `1ª metade de ${nomesMeses[mes +1]} <b>(<u>seguinte)</u></b>`
    }else{
        texto += "1ª"
        texto2 += `2ª metade de ${nomesMeses[mes]} <b>(<u>seguinte)</u></b>`
    }
    

    texto += ` metade de ${nomesMeses[mes]} <b>(<u>atual)</u></b>`
    

    document.getElementById("atual_cpu").innerHTML = texto
    document.getElementById("atual_ram").innerHTML = texto

    document.getElementById("proxima_ram").innerHTML = texto2
    document.getElementById("proxima_cpu").innerHTML = texto2



    texto = `${kpis.cpumin1}%  a ${kpis.cpumax1}%`
    texto2 = `${kpis.cpumin2}%  a ${kpis.cpumax2}%`

    document.getElementById("1_cpu").innerHTML = texto
    document.getElementById("2_cpu").innerHTML = texto2


    texto = `${kpis.rammin1}%  a ${kpis.rammax1}%`
    texto2 = `${kpis.rammin2}%  a ${kpis.rammax2}%`

    document.getElementById("1_ram").innerHTML = texto
    document.getElementById("2_ram").innerHTML = texto2


    // cores das caixas das KPIs:
    if(kpis.cpumax1 >= alertaLevevar){
        document.getElementById("box_1cpu").style.borderColor  = "yellow";
    } else {document.getElementById("box_1cpu").style.borderColor  = "green";}

    if(kpis.cpumax1 >= alertaGravevar){
        document.getElementById("box_1cpu").style.borderColor  = "red";
    }



    if(kpis.cpumax2 >= alertaLevevar){
        document.getElementById("box_2cpu").style.borderColor  = "yellow";
    }else {document.getElementById("box_2cpu").style.borderColor  = "green";}

    if(kpis.cpumax2 >= alertaGravevar){
        document.getElementById("box_2cpu").style.borderColor  = "red";
    }


    if(kpis.rammax1 >= alertaLevevar){
        document.getElementById("box_1ram").style.borderColor  = "yellow";
    }else {document.getElementById("box_1ram").style.borderColor  = "green";}

    if(kpis.rammax1 >= alertaGravevar){
        document.getElementById("box_1ram").style.borderColor  = "red";
    }


    if(kpis.rammax2 >= alertaLevevar){
        document.getElementById("box_2ram").style.borderColor  = "yellow";
    }else {document.getElementById("box_2ram").style.borderColor  = "green";}

    if(kpis.rammax2 >= alertaGravevar){
        document.getElementById("box_2ram").style.borderColor  = "red";
    }

     
}



function desvioPadrao (vetor){
    var soma = 0
    for(var i = 0; i < vetor.length; i++){
        soma += vetor[i]
    }

    var media = soma/vetor.length

    var desvioQuadrado = 0

    for(var i = 0; i < vetor.length; i++){
        desvioQuadrado += ((vetor[i] - media) ^ 2)
    }

    var desvio = ((desvioQuadrado/media) ^ 0.5)

    return desvio
}

function mediaPadrao(vetor){
    var soma = 0
    for(i = 0; i < vetor.length; i++){
        soma += vetor[i]
    }
    return soma/vetor.length
}

// Pegando os valores do bucket:

var CpuServidores = {}
var RamServidores = {}
var horarioServidores = {}
var terAlertaLevesServidores = {}
var terAlertaGravesServidores = {}

   

    async function mandarBuscar (){
            

        // Logica para pegar os dados de todos os servidores daquela empresa:]
        
        for ( var i = 0; i < macServidor.length; i++){

            let NOME_ARQUIVO = `8/${macServidor[i]}/dados_caputrados.csv`;
            let URL_API = `/s3Route/dados/${NOME_ARQUIVO}`;
            await buscarDados(URL_API, macServidor[i], "cpu_porcentagem", "ram_porcentagem")
            // Adiona os valores de CPU e RAM nos objetos criados acima de todos os servidores cadastrados, do dia de hoje
        }




    }
        
        
        
        
        async function buscarDados(URL_API, mac, valor1, valor2) {
            
            

            
            // Referência ao canvas principal e ao container auxiliar para mensagens de erro
            
            // const ctx = document.getElementById('grafico');
            // const carregamento = document.getElementById('area_comparativo_servidores');
            
            // carregamento.innerHTML = 'Carregando dados...'; 
            
            try {
                // requisição à API
                let resposta = await fetch(URL_API);

            // descreve erros 
            if (!resposta.ok) {
                let erroDetalhe = await resposta.text();
                throw new Error(`Erro ${resposta.status}: Falha na API: ${erroDetalhe.substring(0, 100)}`);
            }
            
            // converte a resposta para JSON!!!!!
            let data = await resposta.json();

            // // limpa a mensagem de carregamento
            // carregamento.innerHTML = '';
            // carregamento.appendChild(ctx); // Garante que o canvas volte

            // verifica e Processa os Dados para o Chart.js
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("Erro nos dados recebidos");
                // carregamento.innerHTML = `<div style="color: orange; padding: 20px;">⚠️ Dados vazios para plotar o gráfico.</div>`;
                return;
            }


            // extrai os valores para os eixos

            if (!Array.isArray(data)) {
            data = [data];
             }

        console.log("DATA RECEBIDO DO CSV:", data);


        
        CpuServidores[mac] = data.map(d => Number(d[valor1]));       // CPU
        RamServidores[mac] = data.map(d => Number(d[valor2]) || 0);  // RAM
        horarioServidores[mac] = data.map(d => new Date(d["timestamp"]).getTime());

        console.log("CPU convertida:", CpuServidores[mac][0], typeof CpuServidores[mac][0]);
        console.log("RAM convertida:", RamServidores[mac][0], typeof RamServidores[mac][0]);

        // ultima chamada
        if (mac == macServidor[macServidor.length -1]){
            fazerPredict();

            }
        }
                 catch (error) {
            // Captura e exibe erros
            console.error("Erro ao carregar os dados:", error);
        }

        console.log("");
        
    }

    var alertaLevevar = 0; 
    var alertaGravevar = 0;

    function fazerPredict() {

    const agora = Date.now();
    const referencia = 10800000; // 3 horas em ms

    // Pra cada servidor capturado vai rodar esse for
    for (let j = 0; j < macServidor.length; j++) {

        const mac = macServidor[j]; // servidor atual
        const dadosCPU = CpuServidores[mac];
        const horarios = horarioServidores[mac];

        // Filtrar pra pegar só as ultimas 3hrs pra ser mais preciso no predict
        var cpu3h = [];
        var horarios3h = [];

        for (let i = 0; i < horarios.length; i++) {
            if ((agora - horarios[i]) <= referencia) {
                cpu3h.push(dadosCPU[i]);
                horarios3h.push(horarios[i]);
            }
        }

        var n = cpu3h.length;

        var limiteMaximoPrevisao = 540;

        // Criar o vetor X [0,1,2,3] já que o gap de tempo tem que ser o mesmo sempre
        var x = [];
        for (var i = 0; i < n; i++) {
            x.push(i);
        }

        
        var y = cpu3h; // dados das ultimas 3hrs

        // Somatórias
        var somaX = 0;
        var somaY = 0;
        var somaXY = 0;
        var somaX2 = 0;

        for (let i = 0; i < n; i++) {
            somaX += x[i];
            somaY += y[i];
            somaXY += x[i] * y[i];
            somaX2 += x[i] * x[i];
        }

        // Coeficientes da regressão linear (a + b*x)
        var b = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX);
        var a = (somaY - b * somaX) / n;

        console.log("n" + n);
        

        console.log("a" + a);
        console.log("b" + b);

        

        terAlertaLevesServidores[mac] = null;
        terAlertaGravesServidores[mac] = null;


        // Logica da previsão da bagaceira:

        // var proximoX = n; // próximo índice
        // var previsao = a + b * proximoX; // formula para prever os proximos valores

                    var horarioAlertaLeve = (alertaLevevar - a) / b

                    var horarioAlertaGrave = (alertaGravevar - a) / b

                    console.log("HORArioAlertaLeve:" + horarioAlertaLeve);
                    
            // Isso me dá daqui a quantas medidas vai ter o alerta


                            const proximoPonto = n;
                // LÓGICA DE PREVISÃO CORRIGIDA PARA RISCO CRESCENTE
                // SÓ CALCULA SE A TENDÊNCIA FOR DE CRESCIMENTO (b > 0)
                if (b > 0.00001) { 

                    // Garante que não haja divisão por zero ou infinito
                    if (isFinite(b)) {
                        
                        var horarioAlertaLeve = ((alertaLevevar - a) / b) * 1/3; // 1/3 pra virar minutos
                        var horarioAlertaGrave = ((alertaGravevar - a) / b) * 1/3;

                        // 1. Alerta Leve
                        // Condição: Se a inclinação é positiva, basta que o alerta tenha sido alcançado
                        // em algum momento positivo (horarioAlerta > 0).
                        if (horarioAlertaLeve > 0 && isFinite(horarioAlertaLeve)) { 
                            terAlertaLevesServidores[mac] = horarioAlertaLeve;

                            console.log("Alerta leve na possição " + mac +terAlertaLevesServidores[mac] );
                            

                            if (horarioAlertaLeve <= 60) {
                                    contagemAlertasCPULeve.ate1h++;
                                } else if (horarioAlertaLeve <= 120) {
                                    contagemAlertasCPULeve.ate2h++;
                                } else if (horarioAlertaLeve <= 180) { // 3 horas = 180 minutos
                                    contagemAlertasCPULeve.ate3h++;
                                }
                            
                        }

                        // 2. Alerta Grave
                        if (horarioAlertaGrave > 0 && isFinite(horarioAlertaGrave)) { 
                            terAlertaGravesServidores[mac] = horarioAlertaGrave;

                            console.log("Alerta grave na possição " + mac +terAlertaGravesServidores[mac] );

                            if (horarioAlertaLeve <= 60) {
                                    contagemAlertasCPUGrave.ate1h++;
                                } else if (horarioAlertaGrave <= 120) {
                                    contagemAlertasCPUGrave.ate2h++;
                                } else if (horarioAlertaGrave <= 180) { // 3 horas = 180 minutos
                                    contagemAlertasCPUGrave.ate3h++;
                                }

                        }
    }
    }
        listarServidores()
}}




function listarServidores() {

    var tabela = document.getElementById("tabela");

    var linhas = ""

    var listaRanking = []

    for (var i = 0; i < macServidor.length; i++) {
        var mac = macServidor[i];

        // Cria um objeto para cada servidor e salva em listaRaking
        var obj = {
            mac: mac,
            nome: nomesServidores[mac], // se tiver isso
            leve: terAlertaLevesServidores[mac] != undefined ? terAlertaLevesServidores[mac] : null,
            grave: terAlertaGravesServidores[mac] != undefined ? terAlertaGravesServidores[mac] : null
        };

        listaRanking.push(obj);

    }

    //  Ordenar por quem vai ter o alerta primeiro
    // Selection short

        for (var i = 0; i < listaRanking.length - 1; i++) {

        var indiceMenor = i

        for (var j = i + 1; j < listaRanking.length; j++) {

            // ---- valor do j ----
            var tempoA

            if (listaRanking[j].grave !== null && listaRanking[j].grave !== undefined) {
                tempoA = listaRanking[j].grave;
            } else if (listaRanking[j].leve !== null && listaRanking[j].leve !== undefined) {
                tempoA = listaRanking[j].leve;
            } else {
                tempoA = Infinity;
            }

            // ---- valor do índiceMenor ----
            var tempoB;

            if (listaRanking[indiceMenor].grave !== null && listaRanking[indiceMenor].grave !== undefined) {
                tempoB = listaRanking[indiceMenor].grave;
            } else if (listaRanking[indiceMenor].leve !== null && listaRanking[indiceMenor].leve !== undefined) {
                tempoB = listaRanking[indiceMenor].leve;
            } else {
                tempoB = Infinity;
            }

            // compara os tempos de execução
            if (tempoA < tempoB) {
                indiceMenor = j;
            }
        }

        // Troca
        if (indiceMenor != i) {
            var aux = listaRanking[i];
            listaRanking[i] = listaRanking[indiceMenor];
            listaRanking[indiceMenor] = aux;
        }
    }

    // -----------------------------------------------------------------
    // Monta as linhas da tabela em si
    // ----------------------------- ----------------------------------
    for (var i = 0; i < listaRanking.length; i++) {

        var sv = listaRanking[i];
        var cor = "green"
        var tempo = "-"

        if (sv.grave !== null) {
            cor = "red"
            tempo = sv.grave.toFixed(1) + "min"
        }
        else if (sv.leve !== null) {
            cor = "orange"
            tempo = sv.leve.toFixed(1) + "min"
        }

        linhas += 
            "<tr>" +
                '<td><img src="../../assets/imgs/bandeira_brasil.png" width="50%"></td>' +
                "<td>" + sv.nome + "</td>" +
                '<td style="color:' + cor + '; font-weight:bold;">' + tempo + "</td>" +
            "</tr>"
    }

    // Preencher tabela
    tabela.innerHTML =
        "<tr>" +
            "<th>Pais</th>" +
            "<th>Servidor</th>" +
            "<th>Previsão</th>" +
        "</tr>" +
        linhas


        gerarBarra()
}

var contagemAlertasCPULeve = {
    ate1h: 0,
    ate2h: 0,
    ate3h: 0
}

var contagemAlertasCPUGrave = {
    ate1h: 0,
    ate2h: 0,
    ate3h: 0
};

var graficoPizza = null
var graficoLinha = null

function gerarBarra(){
    const ctx2 = document.getElementById('graf_pizza').getContext('2d');
    
    // Os rótulos (faixas de tempo)
    const labels = ["Até 3h", "Até 2h", "Até 1h"];

    // Os dados (invertermos a ordem para que o "Até 1h" fique no topo do gráfico)
    const dataLeve = [
        contagemAlertasCPULeve.ate3h,
        contagemAlertasCPULeve.ate2h,
        contagemAlertasCPULeve.ate1h
    ];
    const dataGrave = [
        contagemAlertasCPUGrave.ate3h,
        contagemAlertasCPUGrave.ate2h,
        contagemAlertasCPUGrave.ate1h
    ];

    if(graficoPizza){
        graficoPizza.destroy()
    }

  graficoPizza = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Alerta Leve',
                    data: dataLeve,
                    backgroundColor: '#FFCC00', // Amarelo/Laranja para Leve
                    borderColor: 'white',
                    borderWidth: 1,
                },
                {
                    label: 'Alerta Grave',
                    data: dataGrave,
                    backgroundColor: '#FF4136', // Vermelho para Grave
                    borderColor: 'white',
                    borderWidth: 1,
                }
            ]
        },
        options: {
            indexAxis: 'y', // Barras HORIZONTAIS
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    labels: {
                        color: 'white'
                    }
                }, 
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.x !== null) {
                                label += context.parsed.x + ' servidores';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { // Contagem
                    stacked: false, // Barras lado a lado
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        precision: 0 
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: { 
                    ticks: { color: 'white' },
                    grid: { display: false }
                }
            },
            layout: {
                padding: 0
            }
        }
    });

    pegarGrafLinha()
}





// -------------------------------------------------------------------
// Fazendo a logica de pegar os dados para o grafico de linhas
// -------------------------------------------------------------------

let mediasCPUvar = []
let mediasRAMvar = []
let previsoesCPUvar = []
let previsoesRAMvar = []



var tudoCPU = []
var tudoRAM = []

 async function pegarGrafLinha() {
            

            let NOME_ARQUIVO = `resumo.csv`;
            let URL_API = `/s3Route/dados/${NOME_ARQUIVO}`;
            

            
            // Referência ao canvas principal e ao container auxiliar para mensagens de erro
            
            // const ctx = document.getElementById('grafico');
            // const carregamento = document.getElementById('area_comparativo_servidores');
            
            // carregamento.innerHTML = 'Carregando dados...'; 
            
            try {
                // requisição à API
                let resposta = await fetch(URL_API);

            // descreve erros 
            if (!resposta.ok) {
                let erroDetalhe = await resposta.text();
                throw new Error(`Erro ${resposta.status}: Falha na API: ${erroDetalhe.substring(0, 100)}`);
            }
            
            // converte a resposta para JSON!!!!!
            let data = await resposta.json();

            // // limpa a mensagem de carregamento
            // carregamento.innerHTML = '';
            // carregamento.appendChild(ctx); // Garante que o canvas volte

            // verifica e Processa os Dados para o Chart.js
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("Erro nos dados recebidos");
                // carregamento.innerHTML = `<div style="color: orange; padding: 20px;">⚠️ Dados vazios para plotar o gráfico.</div>`;
                return;
            }


            // extrai os valores para os eixos


            mediasCPUvar = data.map(d => Number(d["cpu_media"])).slice(-60); // esse .slice(-30) corta os ultimos 30 valores do vetor
            mediasRAMvar = data.map(d => Number(d["ram_media"])).slice(-60);


            tudoCPU = data.map(d => Number(d["cpu_media"]));
            tudoRAM = data.map(d => Number(d["ram_media"]));




            preverGrafLinha(mediasCPUvar, pontosCPU)
            preverGrafLinha(mediasRAMvar, pontosRAM)
            

            previsoesCPUvar = pontosCPU; 
            previsoesRAMvar = pontosRAM;



            mediasCPUvar = mediasCPUvar.slice(-30); 
            mediasRAMvar = mediasRAMvar.slice(-30);


            for (let i = 0; i < 5; i++) {
            mediasCPUvar.push(null);
            mediasRAMvar.push(null);
            }

            grafLinha()

            
        }
                 catch (error) {
            // Captura e exibe erros
            console.error("Erro ao carregar os dados:", error);
        }

        console.log("");
    }

// var historicoCPU_Base = []
// var historicoRAM_Base = []


var pontosCPU = []
var pontosRAM = []

function preverGrafLinha(referencia, vetor){
    
    var n = 30; 
    var numPrevisoes = 5;
    var totalPontos = n + numPrevisoes; // Total de 35 pontos no gráfico

    var y_base = referencia.slice(-n); 
    
    var x_base = [];
    for (var i = 0; i < n; i++) {
        x_base.push(i); 
    }


    // Regressão

    var somaX = 0;
    var somaY = 0;
    var somaXY = 0;
    var somaX2 = 0;

    for (let i = 0; i < n; i++) {
        somaX += x_base[i];
        somaY += y_base[i];
        somaXY += x_base[i] * y_base[i];
        somaX2 += x_base[i] * x_base[i];
    }

    // a e b
    var b = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX); 
    var a = (somaY - b * somaX) / n;
    
    console.log(`Regressão n=${n} A=${a.toFixed(2)}, B=${b.toFixed(4)}`);

    // Gerando os pontos
    
    vetor.length = 0; // Limpa o vetor
    

    for (let i = 0; i < totalPontos; i++) {

        var x_valor = i; 
        
        var previsao = a + b * x_valor; 

        // Bão deixa o resultado passar de 100%
        vetor.push(Math.min(100, previsao)); 
    }
    
}

vetorSaida = []



function gerarDias() {
    var labels = [];

    var hoje = new Date();

    // 29 dias pra tras
    for (var i = 29; i > 0; i--) {
        var data = new Date(hoje);
        data.setDate(hoje.getDate() - i);

        var dia = String(data.getDate()).padStart(2, "0");
        var mes = String(data.getMonth() + 1).padStart(2, "0");

        labels.push(dia + "/" + mes);
    }

    // dia de hoje
    var diaAtual = String(hoje.getDate()).padStart(2, "0");
    var mesAtual = String(hoje.getMonth() + 1).padStart(2, "0");
    labels.push(diaAtual + "/" + mesAtual);

    //  5 dias pra frente
    for (var j = 1; j <= 5; j++) {
        var futura = new Date(hoje);
        futura.setDate(hoje.getDate() + j);

        var dia = String(futura.getDate()).padStart(2, "0");
        var mes = String(futura.getMonth() + 1).padStart(2, "0");

        labels.push(dia + "/" + mes);
    }

    return labels;
}


function grafLinha(){
            const ctx = document.getElementById('grafico').getContext('2d');
        
        if (graficoLinha) {
        graficoLinha.destroy();
        }

       graficoLinha =  new Chart(ctx, {
            type: 'line',
            data: {
                labels: gerarDias(),
                datasets: [{
                    label: 'CPU usada',
                    data: mediasCPUvar,
                    borderColor: '#004C99',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                },{
                    label: 'CPU prevista',
                    data: previsoesCPUvar,
                    borderColor: '#00BCD4',
                    borderWidth: 3,
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    pointRadius: 0,
                },
                {
                    label: 'RAM usada',
                    data: mediasRAMvar,
                    borderColor: '#A9A9A9',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                },{
                    label: 'RAM prevista',
                    data: previsoesRAMvar,
                    borderColor: '#B3E5FC',
                    borderWidth: 3,
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    pointRadius: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    title: {
                        display: true,
                        text: 'Evolução e previsão da media mensal de uso de CPU e RAM (ultimos 30 e proximos 5 dias)',
                        color: 'white',
                        font: {
                            size: 20,
                            weight: 'bold',
                            family: 'Open Sans'
                        },
                        align: 'center',
                        padding: {
                            bottom: 20
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });

        montar()
}

</script>

</html>


