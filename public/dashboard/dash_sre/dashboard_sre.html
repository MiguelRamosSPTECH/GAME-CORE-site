<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../../css/dash_sre.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
    <script src="../../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
</head>

<body>
    <div class="container-all">
        <div class="nav-lateral">
            <div class="logo-dbg">
                <img src="../../assets/imgs/DBG.-logo2png.png" alt="">
            </div>
            <div class="options-nav ">
                <div class="principal-options">
                    <div class="circle-option">
                        <i onclick="window.location.href='#'" class="fa-solid fa-house"></i>
                        <span class="texto-oculto">Início</span>
                    </div>
                    <div class="circle-option">
                        <i onclick="window.location.href='dashHistoricoAlertaSRE.html'" class="fa-solid fa-bug"></i>
                        <span class="texto-oculto">Alertas</span>
                    </div>
                    <div class="circle-option">
                        <i class="fa-solid fa-notes-medical" onclick="window.location.href='dashSaudeServidores.html'"></i>
                        <span class="texto-oculto">Configurações</span>
                    </div>
                </div>
                <div class="area-logoff">
                    <div class="circle-option logoff" onclick="limparSessao()">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <span class="texto-oculto" style="color: red;">Sair</span>
                    </div>
                </div>
            </div>
        </div>


        
        <div class="corpo">
            <div class="intervalo" >Intervalos de um Desvio-Padrão previstos para os proximos dias  
              <img onclick="mostrar_aviso()" class="toll_tip" src="../../assets/imgs/toll tip.png" height="45px"></div>

            <div class="kpi1">
                <p class="titulo_kpi">CPU Esperada:</p>
                <div class="metade" id="box_1cpu">
                    <p class="desc_metade" id="atual_cpu">2ª metade de novembro <b>(<u>atual)</u></b></p>

                    <p class="medida_metade" id="1_cpu">77%  a 97%</p>
                </div>

                <div class="metade" id="box_2cpu">
                    <p class="desc_metade" id="proxima_cpu">1ª metade de Dezembro  <b>(<u>seguinte)</u></b> </p>

                    <p class="medida_metade" id="2_cpu">80%  a 87%</p>
                </div>

        
            </div>

        
            <div class="kpi2">
            <p class="titulo_kpi">RAM Esperada:</p>
        
                    <div class="metade" style="border-color: green;" id="box_1ram">
                    <p class="desc_metade" id="atual_ram">2ª metade de novembro <b>(<u>atual)</u></b></p>

                    <p class="medida_metade" id="1_ram">55% a 60%</p>
                </div>

                <div class="metade" style="border-color: yellow; " id="box_2ram">
                    <p class="desc_metade" id="proxima_ram">1ª metade de Dezembro  <b>(<u>seguinte)</u></b> </p>

                    <p class="medida_metade" id="2_ram">66% a 70%</p>
                </div>
        </div>

            <div class="vazio"></div>
            <div class="graf">
                <canvas id="grafico"></canvas>
            </div>

        </div>

        <div class="direita_pai">

        <div class="direita1">
            <p class="titulo_direita1">Servidores com alertas previstos em 6 horas</p>    

            <table class="lista_sv">
                <tr>
                    
                </tr>
                <tr>
                    <td><img src="../../assets/imgs/bandeira_brasil.png" width="50%" ></td>
                    <td>minecraft-main</td>
                    <td style="color: red;">5</td>

                </tr>
                                <tr>
                    <td><img src="../../assets/imgs/bandeira_brasil.png" width="50%" ></td>
                    <td>minecraft-main</td>
                    <td style="color: red;">5</td>

                </tr>
            </table>
        </div>


        <div class="direita2"> 
            <p class="titulo_direita1">Alertas previstos por componente em 6 horas</p>                
            
            <canvas id="graf_pizza"></canvas>
        </div>

            
        </div>            


    </div>


    <div id="popup" class="popup">
    <div class="popup_conteudo">
        <p>Nos períodos informados abaixo, aproximadamente 68% do tempo, a porcentagem de uso estará dentro da sua respectiva faixa prevista</p>

        <button onclick="fechar_popup()" class="fechar_popup">Fechar</button>
    </div>
</div>


<p class="titulo">SRE - Previsão de consumo |  Servidores </p>
    <script>

      function mostrar_aviso() {
    document.getElementById("popup").style.display = "flex";
}

function fechar_popup() {
    document.getElementById("popup").style.display = "none";
}













        const ctx = document.getElementById('grafico').getContext('2d');
        

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ["10/11","11/11","12/11","13/11","14/11","15/11","16/11","17/11","18/11","19/11",
                        "20/11","21/11","22/11","23/11","24/11","25/11","26/11","27/11","28/11","29/11",
                        "30/11","01/12","02/12","03/12","04/12","05/12","06/12","07/12","08/12","09/12",
                        "10/12","11/12","12/12","13/12","14/12","15/12","16/12","17/12","18/12","19/12",
                        "20/12","21/12","22/12","23/12","24/12"],
                datasets: [{
                    label: 'CPU usada',
                    data: [5, 9, 12, 18, 21, 25, 28, 32, 36, 40, 43, 47, 50, 53, 57, 60, 63, 66, 70, 72, 75, 78, 82, 84, 87, 90, 92, 94, 97, 99],
                    borderColor: '#004C99',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                },{
                    label: 'CPU prevista',
                    data: [6, 11, 14, 17, 23, 26, 30, 33, 39, 42, 45, 48, 52, 54, 58, 62, 65, 68, 71, 73, 76, 80, 83, 85, 88, 91, 93, 95, 98, 4, 8, 13, 19, 22, 27, 29, 34, 38, 41, 46, 51, 56, 61, 67],
                    borderColor: '#00BCD4',
                    borderWidth: 3,
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    pointRadius: 0,
                },
                {
                    label: 'RAM usada',
                    data: [3, 7, 10, 15, 19, 22, 27, 31, 35, 38, 41, 45, 48, 52, 55, 59, 62, 65, 69, 71, 74, 77, 81, 83, 86, 89, 91, 93, 96, 98],
                    borderColor: '#A9A9A9',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                },{
                    label: 'RAM prevista',
                    data: [2, 6, 11, 14, 18, 24, 28, 33, 37, 40, 44, 49, 53, 57, 60, 64, 66, 70, 73, 76, 79, 82, 85, 87, 90, 92, 95, 97, 99, 4, 8, 12, 16, 21, 25, 29, 34, 39, 43, 47, 51, 58, 63, 68],
                    borderColor: '#B3E5FC',
                    borderWidth: 3,
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.4,
                    pointRadius: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    title: {
                        display: true,
                        text: 'Evolução e previsão da media mensal de uso de CPU e RAM (ultimos 30 e proximos 15 dias)',
                        color: 'white',
                        font: {
                            size: 20,
                            weight: 'bold',
                            family: 'Open Sans'
                        },
                        align: 'center',
                        padding: {
                            bottom: 20
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });

        // LÓGICA DE HOVER DA BARRA LATERAL
        const navLateral = document.querySelector('.nav-lateral');
        const conteudo = document.querySelector('.conteudo');

        navLateral.addEventListener('mouseenter', () => {
            conteudo.classList.add('expand');
        });

        navLateral.addEventListener('mouseleave', () => {
            conteudo.classList.remove('expand');
        });



                const ctx2 = document.getElementById('graf_pizza').getContext('2d');
        

        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ["CPU", "RAM"],
                datasets: [{
                    label: 'CPU',
                    data: [20,30],
                    backgroundColor: ['#6ce5e8', '#16c4d4'],
                    borderColor: '#6ce5e8',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    title: {
                        display: true,
                        color: 'white',
                        font: {
                            size: 20,
                            weight: 'bold',
                            family: 'Open Sans'
                        },
                        align: 'center',
                        padding: {
                            top: -25
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { display: false }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });


    </script>
</body>

<script>
// Script backend em si:

var alertaGravevar = 0
var alertaLevevar = 0



// entrar()

 function entrar() {
        

        var idEmpresa = sessionStorage.ID_EMPRESA

        console.log("FORM idEmpresa: ", idEmpresa);


        fetch(`/sre_futuro/entrar/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: idEmpresa,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);
                // PEGAR do sessionStorage = var idEmpresa = sessionStorage.ID_EMPRESA;
                // Salvar no sessionStorage = sessionStorage.EMAIL_USUARIO = json.email;
                resposta.json().then(json => {
                    console.log(json);
                    console.log("Print do SRE FUTURO:");
                    
                    console.log(JSON.stringify(json));

                    
                    alertaLevevar = Number ((json[0].alertaLeve));
                    alertaGravevar = Number ((json[0].alertaGrave));

                    buscarServidores()
                
                    
                    

                });

            } else {

                console.log("Houve um erro ao tentar realizar o as previsões com alertas!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    
    var nomesServidores = []
    var localizacaoServidores = []


  function buscarServidores() {
        
        var idEmpresa = sessionStorage.ID_EMPRESA

        console.log("FORM idEmpresa: ", idEmpresa);


        fetch(`/sre_futuro/buscar/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: idEmpresa,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO buscarServidores()!")

            if (resposta.ok) {
                console.log(resposta);
                // PEGAR do sessionStorage = var idEmpresa = sessionStorage.ID_EMPRESA;
                // Salvar no sessionStorage = sessionStorage.EMAIL_USUARIO = json.email;
                resposta.json().then(json => {
                    console.log(json);
                    console.log("Print do SRE FUTURO: Lista de servidores:");
                    
                    console.log(JSON.stringify(json));

                        for(i = 0; i < json.length; i++){
                            nomesServidores.push(json[i].apelido);
                            localizacaoServidores.push(json[i].localizacao);
                        }



                        montar()
                    
                    

                });

            } else {

                console.log("Houve um erro ao tentar realizar o as previsões com alertas!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }


    var kpis = {
        cpumin1 : 0,
        cpumax1: 0,
        cpumin2: 0,
        cpumax2: 0,

        rammin1: 0,
        rammax1: 0,
        rammin2: 0,
        rammax2: 0,
    }







// montando o Site:


function montar() {

    var dataAtual = new Date();
    var mes = dataAtual.getMonth()
    var dia = dataAtual.getDate()

    var nomesMeses = [
    "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
]

    var texto = ''
    var texto2 = ''


    if(dia >= 15){
        texto += "2ª"
        texto2 += `1ª metade de ${nomesMeses[mes +1]} <b>(<u>seguinte)</u></b>`
    }else{
        texto += "1ª"
        texto2 += `2ª metade de ${nomesMeses[mes]} <b>(<u>seguinte)</u></b>`
    }
    

    texto += ` metade de ${nomesMeses[mes]} <b>(<u>atual)</u></b>`
    

    document.getElementById("atual_cpu").innerHTML = texto
    document.getElementById("atual_ram").innerHTML = texto

    document.getElementById("proxima_ram").innerHTML = texto2
    document.getElementById("proxima_cpu").innerHTML = texto2



    texto = `${kpis.cpumin1}%  a ${kpis.cpumax1}%`
    texto2 = `${kpis.cpumin2}%  a ${kpis.cpumax2}%`

    document.getElementById("1_cpu").innerHTML = texto
    document.getElementById("2_cpu").innerHTML = texto2


    texto = `${kpis.rammin1}%  a ${kpis.rammax1}%`
    texto2 = `${kpis.rammin2}%  a ${kpis.rammax2}%`

    document.getElementById("1_ram").innerHTML = texto
    document.getElementById("2_ram").innerHTML = texto2


    // cores das caixas das KPIs:
    if(kpis.cpumax1 >= alertaLevevar){
        document.getElementById("box_1cpu").style.borderColor  = "yellow";
    } else {document.getElementById("box_1cpu").style.borderColor  = "green";}

    if(kpis.cpumax1 >= alertaGravevar){
        document.getElementById("box_1cpu").style.borderColor  = "red";
    }



    if(kpis.cpumax2 >= alertaLevevar){
        document.getElementById("box_2cpu").style.borderColor  = "yellow";
    }else {document.getElementById("box_2cpu").style.borderColor  = "green";}

    if(kpis.cpumax2 >= alertaGravevar){
        document.getElementById("box_2cpu").style.borderColor  = "red";
    }


    if(kpis.rammax1 >= alertaLevevar){
        document.getElementById("box_1ram").style.borderColor  = "yellow";
    }else {document.getElementById("box_1ram").style.borderColor  = "green";}

    if(kpis.rammax1 >= alertaGravevar){
        document.getElementById("box_1ram").style.borderColor  = "red";
    }


    if(kpis.rammax2 >= alertaLevevar){
        document.getElementById("box_2ram").style.borderColor  = "yellow";
    }else {document.getElementById("box_2ram").style.borderColor  = "green";}

    if(kpis.rammax2 >= alertaGravevar){
        document.getElementById("box_2ram").style.borderColor  = "red";
    }

}







// Pegando os valores do bucket:
    
    buscarDados()

    async function buscarDados() {

    let NOME_ARQUIVO = 'pix/dados.json';

    // URL
    let URL_API = `/s3Route/dados/${NOME_ARQUIVO}`;

    // Chaves pro gráfico
    let CHAVE_ROTULO = 'AnoMes'; // Eixo X
    let CHAVE_VALOR = 'QUANTIDADE'; // Eixo Y


        // Referência ao canvas principal e ao container auxiliar para mensagens de erro
        
        // const ctx = document.getElementById('grafico');
        // const carregamento = document.getElementById('area_comparativo_servidores');

        // carregamento.innerHTML = 'Carregando dados...'; 

        try {
            // requisição à API
            let resposta = await fetch(URL_API);

            // descreve erros 
            if (!resposta.ok) {
                let erroDetalhe = await resposta.text();
                throw new Error(`Erro ${resposta.status}: Falha na API: ${erroDetalhe.substring(0, 100)}`);
            }
            
            // converte a resposta para JSON!!!!!
            let data = await resposta.json();

            // // limpa a mensagem de carregamento
            // carregamento.innerHTML = '';
            // carregamento.appendChild(ctx); // Garante que o canvas volte

            // verifica e Processa os Dados para o Chart.js
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("Erro nos dados recebidos");
                // carregamento.innerHTML = `<div style="color: orange; padding: 20px;">⚠️ Dados vazios para plotar o gráfico.</div>`;
                return;
            }

            // extrai os valores para os eixos
            const labels = data.map(d => d[CHAVE_ROTULO]); 
            const valores = data.map(d => Number(d[CHAVE_VALOR]) || 0);

            alert(labels + valores)
        }
                 catch (error) {
            // Captura e exibe erros
            console.error("Erro ao carregar os dados:", error);
        }

        console.log("");
        
    }

</script>

</html>