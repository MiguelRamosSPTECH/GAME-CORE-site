
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Saúde do Servidor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <link rel="stylesheet" href="../../css/dash/saude_servidor_manu.css" />
  <link href="https:fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https:cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>

<div class="container-all">

  <div class="nav-lateral">
    <div class="logo-dbg">
      <img src="../../assets/imgs/DBG.-logo2png.png">
    </div>

    <div class="options-nav">
      <div class="principal-options">
        <div class="circle-option">
          <i onclick="window.location.href='dashboard_sre.html'" class="fa-solid fa-house"></i>
        </div>

        <div class="circle-option">
          <i onclick="window.location.href='dashHistoricoAlertaSRE.html'" class="fa-solid fa-bug"></i>
        </div>

        <div class="circle-option">
          <i onclick="window.location.href='#'" class="fa-solid fa-notes-medical"></i>
        </div>
      </div>

      <div class="area-logoff">
        <div class="circle-option logoff" onclick="limparSessao()">
          <i class="fa-solid fa-right-from-bracket"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTEÚDO PRINCIPAL -->
  <div class="container">

    <div class="bloco-esquerda">

      <!-- KPIs -->
      <div class="kpis">
        <div class="card kpi-processos">
          <h5>Total de Processos em Execução</h5>
          <h3 id="totalProcessosExec">345</h3>
        </div>

        <div class="card kpi-cpu">
          <h4>Tempo de CPU</h4>
         <p> <span style="color: #55c0ff">Usuário</span> VS <span style="color: #9a7bff;;">Sistema</span> </p>
          <canvas id="cpuChart"  height="100"></canvas>
        </div>
      </div>

      <!-- Desempenho / Tempo de Espera -->
      <div class="card-grafico">
        <h3 class="titulo">Desempenho x Tempo de Espera</h3>
        <canvas id="desempenhoChart"></canvas>
      </div>

      <!-- Taxa de Swap + Utilização RAM -->
      <div class="blocos-mistos">

        <div class="graficoSwap bloco-meio">
          <h3 class="titulo">Taxa de Swap</h3>
          <canvas id="swapChart"></canvas>
        </div>

        <div class="graficoRam bloco-meio">
          <h3 class="titulo">Utilização RAM</h3>

          <div class="pie-area">
            <canvas id="ramChart" width="200"></canvas>
          </div>

          <div class="legenda-pie">
            <div class="disp">Disponível</div>
            <div class="util">Utilizada</div>
          </div>
        </div>

      </div>

    </div>

    <!-- Bloco direita -->
    <div class="bloco-direita">

      <div class="cima">
          <div class="card-kpi-alertas">
          <h3 class="titulo">Qtd. alertas no último mês</h3>
          <h1 id="totalAlertasMes" style="font-size:40px;">14</h1>
        </div>

        <div class="uiverse">
    <span class="tooltip"><img src="../../assets/imgs/jira_icon.png" alt="Alert Icon" width="15px"></span>
    <span onclick="window.location.href='https:gamecore.atlassian.net/jira/software/projects/KAN/list?jql=project%20%3D%20%22KAN%22%20ORDER%20BY%20created%20DESC'">
        Ver Alertas
    </span>
</div>
      </div>
      
      <div class="baixo">
      <div class="card-correlacao">
        <h3 class="titulo">Tendência e Correlação de Alertas</h3>
        <canvas id="alertasChart"></canvas>
      </div>
      </div>


    </div>

  </div>

  <div id="mensagem" style="color:white; padding:10px;"></div>

</div>


 <script>
    
    const NOME_ARQUIVO = 'dashboard_metricas_manu.json';
    const URL_API = `/s3Route/dados/${NOME_ARQUIVO}`;

    
    const CHAVE_CPU_SISTEMA = 'cpuSystemTimeSeries';
    const CHAVE_CPU_USUARIO = 'cpuUserTimeSeries';
    const CHAVE_DESEMPENHO = 'desempenhoTimeSeries'; 
    const CHAVE_TEMPO_ESPERA = 'esperaTimeSeries'; 
    const CHAVE_SWAP = 'swapTimeSeries'; 

    
 
    const CHAVE_ALERTAS_MES_SERIE = 'alertasMesTimeSeries';
    const CHAVE_PICO_RAM_SERIE = 'picoMaxRamMesTimeSeries';
    const CHAVE_PICO_CPU_SERIE = 'picoMaxCpuMesTimeSeries';
    const CHAVE_PICO_PROCESSOS_SERIE = 'picoMaxProcessosMesTimeSeries';

    
    
    const CHAVE_RAM_DISPONIVEL = 'ramDisponivelPercent';
    const CHAVE_RAM_UTILIZADA = 'ramUtilizadaPercent';
    const CHAVE_TOTAL_PROCESSOS = 'totalProcessos';
    const CHAVE_TOTAL_ALERTAS_MES_KPI = 'totalAlertasMes'; 
  
    // const CHAVE_PICO_MAX_CPU_KPI = 'picoMaxCpuMesPercentual';
    // const CHAVE_PICO_MAX_RAM_KPI = 'picoMaxRamMesPercentual';
    // const CHAVE_PICO_MAX_PROCESSOS_KPI = 'picoMaxProcessosMes';


    async function buscarDados() {
        // Referência ao canvas principal e ao container auxiliar para mensagens de erro
        
        const carregamento = document.getElementById('mensagem');

        carregamento.innerHTML = 'Carregando dados...'; 

        try {
            // requisição à API
            const resposta = await fetch(URL_API);

            // descreve erros 
            if (!resposta.ok) {
                const erroDetalhe = await resposta.text();
                throw new Error(`Erro ${resposta.status}: Falha na API: ${erroDetalhe.substring(0, 100)}`);
            }

            // converte a resposta para JSON
            const data = await resposta.json();

            // limpa a mensagem de carregamento
            carregamento.innerHTML = '';


    
            if (!data || !data[CHAVE_CPU_SISTEMA] || data[CHAVE_CPU_SISTEMA].length === 0) {
                console.warn("Erro nos dados recebidos: Objeto nulo ou série temporal principal vazia.");
                carregamento.innerHTML = `<div style="color: orange; padding: 20px;">⚠️ Dados vazios para plotar o gráfico.</div>`;
                return;
            }

       
            const labelsDiarios = data[CHAVE_CPU_SISTEMA].map(d => {
                return new Date(d.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'UTC' });
            });

            const valoresCPUUsuario = data[CHAVE_CPU_USUARIO].map(d => Number(d.value) || 0);
            const valoresCPUSistema = data[CHAVE_CPU_SISTEMA].map(d => Number(d.value) || 0);
            const valoresDesempenho = data[CHAVE_DESEMPENHO].map(d => Number(d.value) || 0);
            const valoresEspera = data[CHAVE_TEMPO_ESPERA].map(d => Number(d.value) || 0);
            const valoresSwap = data[CHAVE_SWAP].map(d => Number(d.value) || 0);
            
        
            const serieAlertas = data[CHAVE_ALERTAS_MES_SERIE] || []; 
            
            const labelsMensais = serieAlertas.map(d => {
                return new Date(d.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' });
            });
            
            const valoresAlertasMes = serieAlertas.map(d => Number(d.value) || 0);
            const valoresPicoCpuMes = (data[CHAVE_PICO_CPU_SERIE] || []).map(d => Number(d.value) || 0);
            const valoresPicoRamMes = (data[CHAVE_PICO_RAM_SERIE] || []).map(d => Number(d.value) || 0);
            const valoresPicoProcessosMes = (data[CHAVE_PICO_PROCESSOS_SERIE] || []).map(d => Number(d.value) || 0);

          
            const ramDisponivel = Number(data[CHAVE_RAM_DISPONIVEL]) || 0;
            const ramUtilizada = Number(data[CHAVE_RAM_UTILIZADA]) || 0;
            const valoresRam = [ramDisponivel, ramUtilizada]; 

            const totalProcessos = Number(data[CHAVE_TOTAL_PROCESSOS]) || 0;
            const totalAlertasMesKPI = Number(data[CHAVE_TOTAL_ALERTAS_MES_KPI]) || 0;
            const picoMaxCpuKPI = Number(data[CHAVE_PICO_MAX_CPU_KPI]) || 0;
            const picoMaxRamKPI = Number(data[CHAVE_PICO_MAX_RAM_KPI]) || 0;
            const picoMaxProcessosKPI = Number(data[CHAVE_PICO_MAX_PROCESSOS_KPI]) || 0;

            
          
            if (document.getElementById('totalProcessosExec')) document.getElementById('totalProcessosExec').innerText = totalProcessos;
            if (document.getElementById('totalAlertasMes')) document.getElementById('totalAlertasMes').innerText = totalAlertasMesKPI;

            
            
            
            Chart.defaults.color = '#FFFFFF'
                            
            // ======== CPU Chart  ========
            new Chart(document.getElementById("cpuChart"), {
                type: "line",
                data: {
                    labels: labelsDiarios, 
                    datasets: [
                        {
                            label: "Sistema",
                            data: valoresCPUSistema,
                            borderColor: "#9a7bff",
                            pointBackgroundColor: "#9a7bff",
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: "Usuário",
                            data: valoresCPUUsuario,
                            borderColor: "#55c0ff",
                            pointBackgroundColor: "#55c0ff",
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                color: "#fff",
                                boxWidth: 10,
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: "#bbb" },
                            grid: { display: false }
                        },
                        y: {
                            ticks: { color: "#bbb" },
                            grid: { color: "rgba(255,255,255,0.08)" },
                            min: 0,
                            max: 100, 
                        }
                    }
                }
            });


            // ======== Desempenho x Tempo de Espera ========
            new Chart(document.getElementById("desempenhoChart"), {
                type: "line",
                data: {
                    labels: labelsDiarios, 
                    datasets: [
                        {
                            label: "Desempenho",
                            data: valoresDesempenho,
                            borderColor: "#55c0ff",
                            pointBackgroundColor: "#55c0ff",
                            tension: 0.3,
                            borderWidth: 3,
                            fill: false
                        },
                        {
                            label: "Tempo de Espera",
                            data: valoresEspera,
                            borderColor: "#9a7bff",
                            pointBackgroundColor: "#9a7bff",
                            tension: 0.3,
                            borderWidth: 3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: "#fff",
                                usePointStyle: true,
                                boxWidth: 10
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: "#bbb" }, grid: { color: "rgba(255,255,255,0.08)" } },
                        y: { ticks: { color: "#bbb" }, grid: { color: "rgba(255,255,255,0.08)" } }
                    }
                }
            });


            // ======== Swap ========
            new Chart(document.getElementById("swapChart"), {
                type: "line",
                data: {
                    labels: labelsDiarios,
                    datasets: [{
                        label: "Swap",
                        data: valoresSwap,
                        borderColor: "#55c0ff",
                        pointBackgroundColor: "#55c0ff",
                        borderWidth: 3,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: "#bbb" }, grid: { color: "rgba(255,255,255,0.08)" } },
                        y: { ticks: { color: "#bbb" }, grid: { color: "rgba(255,255,255,0.08)" } }
                    }
                }
            });


            // ======== RAM ========
            new Chart(document.getElementById("ramChart"), {
                type: "doughnut",
                data: {
                    labels: ["Disponível", "Utilizada"],
                    datasets: [{
                        data: valoresRam,
                        backgroundColor: ["#55c0ff", "#9a7bff"],
                        borderWidth: 5,
                        borderColor: "#151025"
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: "70%",
                    plugins: { legend: { display: false } }
                }
            });


           
            new Chart(document.getElementById("alertasChart"), {
                type: "bar",
                data: {
                    labels: labelsMensais, 
                    datasets: [
                        {
                            type: "bar",
                            label: "Alertas Mensais",
                            data: valoresAlertasMes, 
                            backgroundColor: "rgba(85,192,255,0.7)",
                            borderColor: "#55c0ff",
                            borderWidth: 1,
                            yAxisID: 'yAlertas' 
                        },
                        {
                            type: "line",
                            label: "Pico Máx. CPU (%)",
                            data: valoresPicoCpuMes, 
                            borderColor: "#9a7bff",
                            pointBackgroundColor: "#9a7bff",
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'yCpu' 
                        },
                        
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: "#fff" }
                        }
                    },
                    scales: {
                        x: { ticks: { color: "#ccc" }, grid: { display: false } },
                        yAlertas: {
                            position: 'left',
                            ticks: { color: "#ccc", precision: 0 },
                            grid: { color: "rgba(255,255,255,0.08)" },
                            title: { display: true, text: 'Alertas (Contagem)', color: '#fff' },
                            min: 0
                        },
                        yCpu: { 
                            position: 'right',
                            ticks: { color: "#ccc" },
                            grid: { drawOnChartArea: false }, 
                            title: { display: true, text: 'Pico CPU (%)', color: '#fff' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });


        } catch (error) {
            
            console.error("❌ Erro ao carregar ou plotar dados:", error);
            if (carregamento) {
                carregamento.innerHTML = `<div style="color: red; padding: 20px;"> ❌ Falha ao carregar dados. ${error.message}</div>`;
            }
        }
    }
    window.onload = buscarDados;

</script>

</body>
</html>
